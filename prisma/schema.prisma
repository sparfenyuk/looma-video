generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum LinkPlatform {
  YOUTUBE
  INSTAGRAM
  TIKTOK
  UNKNOWN
}

enum LinkStatus {
  PENDING
  INGESTING
  READY
  FAILED
}

enum JobType {
  LINK_INGEST
  TRANSCRIPT_FETCH
  LLM_SUMMARIZE
  COURSE_COMPOSE
}

enum JobStatus {
  QUEUED
  PROCESSING
  COMPLETED
  FAILED
}

enum PaymentStatus {
  PENDING
  REQUIRES_ACTION
  PAID
  REFUNDED
  FAILED
}

model User {
  id             String           @id @default(auto()) @map("_id") @db.ObjectId
  email          String           @unique
  name           String?
  image          String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  accounts       Account[]
  creatorProfile CreatorProfile?
  viewerProgress ViewerProgress[]
  payments       Payment[]

  @@map("users")
}

model Account {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  userId           String   @db.ObjectId
  user             User     @relation(fields: [userId], references: [id])
  stripeCustomerId String?
  plan             String?
  createdAt        DateTime @default(now())

  @@index([userId])
  @@map("accounts")
}

model CreatorProfile {
  id         String      @id @default(auto()) @map("_id") @db.ObjectId
  userId     String      @unique @db.ObjectId
  user       User        @relation(fields: [userId], references: [id])
  handle     String      @unique
  brandColor String?
  logoUrl    String?
  subdomain  String?
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  courses    Course[]
  links      LinkAsset[]

  @@map("creator_profiles")
}

model LinkAsset {
  id                String         @id @default(auto()) @map("_id") @db.ObjectId
  creatorId         String         @db.ObjectId
  creator           CreatorProfile @relation(fields: [creatorId], references: [id])
  url               String
  platform          LinkPlatform
  externalId        String
  title             String?
  description       String?
  durationSec       Int?
  thumbnailUrl      String?
  rawTranscriptText String?
  language          String?
  fetchedAt         DateTime?
  status            LinkStatus     @default(PENDING)
  metadataJson      Json?
  transcriptHash    String?
  embedPayload      Json?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  lessons           Lesson[]

  @@unique([creatorId, externalId])
  @@index([creatorId, status])
  @@map("link_assets")
}

model Course {
  id             String           @id @default(auto()) @map("_id") @db.ObjectId
  creatorId      String           @db.ObjectId
  creator        CreatorProfile   @relation(fields: [creatorId], references: [id])
  slug           String           @unique
  title          String
  subtitle       String?
  coverUrl       String?
  isPublished    Boolean          @default(false)
  isPaid         Boolean          @default(false)
  priceCents     Int?
  currency       String?          @default("usd")
  seoDescription String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  publishedAt    DateTime?
  modules        Module[]
  lessons        Lesson[]
  payments       Payment[]
  viewerProgress ViewerProgress[]

  @@index([creatorId])
  @@map("courses")
}

model Module {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  courseId    String   @db.ObjectId
  course      Course   @relation(fields: [courseId], references: [id])
  index       Int
  title       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  lessons     Lesson[]

  @@index([courseId, index])
  @@map("modules")
}

model Lesson {
  id          String           @id @default(auto()) @map("_id") @db.ObjectId
  courseId    String           @db.ObjectId
  moduleId    String           @db.ObjectId
  linkAssetId String?          @db.ObjectId
  course      Course           @relation(fields: [courseId], references: [id])
  module      Module           @relation(fields: [moduleId], references: [id])
  linkAsset   LinkAsset?       @relation(fields: [linkAssetId], references: [id])
  index       Int
  title       String
  summary     String?
  keyPoints   Json?
  difficulty  String?
  estMinutes  Int?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  progress    ViewerProgress[]

  @@index([courseId, moduleId, index])
  @@map("lessons")
}

model ViewerProgress {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  userId      String?  @db.ObjectId
  user        User?    @relation(fields: [userId], references: [id])
  courseId    String   @db.ObjectId
  course      Course   @relation(fields: [courseId], references: [id])
  lessonId    String   @db.ObjectId
  lesson      Lesson   @relation(fields: [lessonId], references: [id])
  sessionId   String?
  completedAt DateTime @default(now())

  @@index([userId, courseId])
  @@index([sessionId])
  @@map("viewer_progress")
}

model Payment {
  id               String        @id @default(auto()) @map("_id") @db.ObjectId
  courseId         String        @db.ObjectId
  course           Course        @relation(fields: [courseId], references: [id])
  userId           String?       @db.ObjectId
  user             User?         @relation(fields: [userId], references: [id])
  buyerEmail       String
  stripeCheckoutId String
  amountCents      Int
  currency         String        @default("usd")
  status           PaymentStatus @default(PENDING)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  @@index([courseId])
  @@index([buyerEmail])
  @@map("payments")
}

model Job {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  type        JobType
  queueName   String
  payload     Json
  status      JobStatus @default(QUEUED)
  attempts    Int       @default(0)
  lastError   String?
  availableAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([type, status])
  @@map("jobs")
}
